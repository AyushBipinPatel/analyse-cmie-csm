---
title: "Reproducibility Check"
author: "Ayush"
format: 
  html:
    code-fold: true
---

# What is this document?

Here in this doc I will try and reproduce some of the results in the World Bank paper "Intent to implementation: Summary of lessons from tracking India's social protection response to COVID-19".

Doing this will help establish if I am applying the weights correctly for analysing the CMIE's data. 

# Which datasets are is used?

Looking at all the data shared by the WB, it seems that the results in the paper are produced using the CSM module. WB has provided with CSM 1-7. At this stage I am unsure if the results are generated using all 7 waves or a select number of wave from these 7.

We will be using the responses to the household frame to this module as the questions/results of interest are in HH frame.


```{r libraries}
#| include: false
#| message: false
#| warning: false

library(here) # to handle addresses
library(dplyr) # data wrangling

```

# Are questions same across CSM1-CSM7

The data set of the CSM module is provided in 8 csv files. Collected across 7 waves (CSM1-7). We are responses to the HH frame of this module. 

It is possible that the number of questions, the questions and their sequencing was changed during the execution of these modules. It  would be sane to check this before merging the data and generating results from it. 

One way to check this is to read the 7 questionnaires and list and compare the questions in the household frame. This will take time. Alternatively, I can read the data from the 8 csv files and compare column names and number of column. The drawback ^[This seems like a reasonable risk to take for this exercise] of the alternate method is that we wont know if there are subtle changes in the manner a question is asked across waves and the number of questions and column names are not changed. 

## Import data and ckeck

```{r imp-check}
#| warning: false
#| message: false
#| include: false


# Get column names of all 8 files and compare

## list all files and create addresses

paste0("data/data-csm/",
       list.files("data/data-csm/"),
       sep ="") -> files_addresses

## read these files and extract column names

purrr::map(files_addresses,
           .f = ~readr::read_csv(file = .x,
                                n_max = 10)|>
             names(),
             ) -> files_col_names


names(files_col_names) <- paste0("CSM",
                                 c("1","2","3","4",
                                   "5","6","7a","7b"))

```

```{r num-col}
tibble(
  `CSM Wave` = purrr::map_dbl(
    files_col_names,length
    )|>
    names(),
  `Number of Questions/Columns` = purrr::map_dbl(
    files_col_names,length
    )
)|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Question/Columns across CSM Waves",
                 subtitle = "Note that CSM 7 had two data files")


```

Clearly, there has been changes to the questionnaire across the waves. __We should get confirmation regarding which wave data was used to generate the results in the WB paper.__ 

It might be that the questions we are interested in are present in the questionnaire across all the waves.

:::{.callout-note}
WB has confirmed that the numbers in the paper were generated by using responses to CSM 1 only.
:::

# Reproducing the results

In order to reproduce the results it is necessary to note the following from the paper:

:::{.callout-important}
"For analytical tractability, households are classified
as those that received food only, cash only and both
food and cash benefits. Food benefits comprise
of access to PDS rations while cash comprises of
transfers received under all PMGKY schemes except
PDS and provident fund withdrawals. NREGA
related cash receipts were not included in the
survey module and are excluded in this analysis.
Additionally, EPF withdrawals are excluded in the
analysis (even though the survey captures this
information) because of the smaller proportion of
households that are enrolled in the program."
:::



## Read CSM1

Here the data is imported from a `csv` file and the only observations with `response_status == "Accepted"` are preserved. Consequently, the new variable `w_cntry` is created as a product of `hh_weight_for_country_w` and `hh_non_response_for_country_w`.

A small peek into the data set provided below.

```{r imp-csm1}
#| message: false
#| warning: false


csm1 <- readr::read_csv("data/data-csm/hh_csm_r1.csv")

# keep only accepted responses

csm1|>
  filter(response_status == "Accepted") -> csm1


# create country level adjusted weight

csm1|>
  mutate(
    w_cntry = hh_weight_for_country_w * hh_non_response_for_country_w
  ) -> csm1

csm1|>
  head(50)|>
  knitr::kable()|>
  kableExtra::kable_styling()|>
  kableExtra::scroll_box(width = "100%", height = "400px")
  

```

## Reproduce: "Across the country, nearly 74% of all households received food through PDS allocations, 40%  of households received cash-transfers."

```{r rep1}
csm1|>
  mutate(
    food_ben = ifelse(
      as.numeric(rice_bought_from_pds_shop_in_prev_cal_mth_in_kg) > 0 |
        as.numeric(wheat_atta_bought_from_pds_shop_in_prev_cal_mth_in_kg) > 0 |
        as.numeric(pulses_bought_from_pds_shop_in_prev_cal_mth_in_kg) > 0,
      1,0
    ),
    cash_ben = ifelse(
      !(received_amt_in_rs_from_jan_dhan_scheme %in% c("0","Not Applicable"))|
        !(received_amt_in_rs_from_pm_kisan_scheme  %in% c("0","Not Applicable"))|
        !(received_amt_in_rs_from_lpg_scheme  %in% c("0","Not Applicable"))|
        !(received_amt_in_rs_from_pension_scheme %in% c("0","Not Applicable")),
      1,0
    )
  )|>
  summarise(
    food_ben_perc  = weighted.mean(food_ben, w_cntry),
    cash_ben_perc  = weighted.mean(cash_ben, w_cntry)
  )



```

:::{.callout-tip}
### Sucessful replication for:
Across the country, nearly 74% of all households received food through PDS allocations, 40%  of households received cash-transfers. The reproduced results are not show in % format.
:::


## Reproduce: "While nearly 85% of all rural households’ report accessing food or cash benefits following the pandemic, only 69.2% of urban households report the same."

Assuming here by "accessing food or cash" it is meant that HHs that can access either one or both.

```{r rep2}

csm1|>
  mutate(
    food_ben = ifelse(
      as.numeric(rice_bought_from_pds_shop_in_prev_cal_mth_in_kg) > 0 |
        as.numeric(wheat_atta_bought_from_pds_shop_in_prev_cal_mth_in_kg) > 0 |
        as.numeric(pulses_bought_from_pds_shop_in_prev_cal_mth_in_kg) > 0,
      1,0
    ),
    cash_ben = ifelse(
      !(received_amt_in_rs_from_jan_dhan_scheme %in% c("0","Not Applicable"))|
        !(received_amt_in_rs_from_pm_kisan_scheme  %in% c("0","Not Applicable"))|
        !(received_amt_in_rs_from_lpg_scheme  %in% c("0","Not Applicable"))|
        !(received_amt_in_rs_from_pension_scheme %in% c("0","Not Applicable")),
      1,0
    ),
    food_or_cash = ifelse(
      food_ben == 1 | cash_ben == 1,
      1,0
    )
  )|>
  group_by(region_type)|>
  summarise(
    perc_food_or_cash = weighted.mean(food_or_cash, w_cntry)
  )

```

:::{.callout-tip}
### Sucessful replication for:
While nearly 85% of all rural households’ report accessing food or cash benefits following the pandemic, only 69.2% of urban households report the same.
:::



