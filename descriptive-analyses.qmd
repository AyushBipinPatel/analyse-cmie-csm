---
title: "Descriptive Analyses - CMIE data"
author: "Ayush Patel"
date: "August, 15 2023"
self-contained: true
execute: 
  warning: false
format:
  html:
    comments:
      hypothesis: true
    toc: true
    toc-location: right
    code-fold: true
---

# Descriptive Analyses of CMIE data

This document is created to carry out descriptive analyses of CMIE data in order to understand and record various aspects of households and individuals who are involved in or closely related to casual or informal labour.

In this document I will try to provide, if feasible, comparisons and cross sections with the Urban-Rural, India-Maharashtra, Agri Labour - non Agri Labour lens.

```{r libr-data}
#| include: false

# Libraries

library(here)
library(dplyr)
library(tidyr)
library(DescTools)
library(ggplot2)

# Data sets

readr::read_csv(here("data/data-for-descriptive-analysis/household_income_20230228_MS.csv")) ->  data_household_incomes


# keep response that are complete and create weights

data_household_incomes|>
  filter(RESPONSE_STATUS == "Accepted")|>
  mutate(
    w_cntry = HH_WEIGHT_FOR_COUNTRY_MS * HH_NON_RESPONSE_FOR_COUNTRY_MS,
    w_state = HH_WEIGHT_FOR_STATE_MS * HH_NON_RESPONSE_FOR_STATE_MS
  ) -> data_household_incomes

```



# Household Incomes

Below is the CMIE's intro note for the Household Incomes data.

>Income Pyramidsdx presents monthly time-series of income of sample households and its composition by sources. The sources of income include wages and pensions earned by members, dividends earned by them on equity investments, interest on savings and income from deposits, provident fund and insurance. It also includes household income from rent, transfers, business profits and sale of assets.

We are using the file `household_income_20230228_MS.csv` form the Jan 23 - Feb 23 round.

## Variables of Interest - Household Income

Below listed are the variables/columns^[I will be using the words variables and columns interchangeably.] available in the household incomes data set. Along with the names of the variables, I also provide, for a select variables of interest, description that CMIE Provides on their website.

```{r show-cols}
#| column: margin

# show all the columns of the household incomes data set

data_household_incomes |>
  names() -> var_names

var_names # show all variable names

```

```{r show-def}
tibble(
  Variables = var_names[c(1,2,5,12,19:22)],
  `CMIE Definitions` = c(
    "Each household that is a part of the sample, is assigned a unique identity number. An identity number assigned to a particular household is never assigned to any other household. Not even if we replace one household in the sample with another.",
    "This is the State or Union Territory in which the sample household is located.",
    "Type of region indicates whether a household is in rural regions or in urban regions. A household is considered to be in a rural region if it is located in a village according to the 2011 Census. Similarly a household is considered to be in an urban region if it is located in a town according to the 2011 Census.",
    "This data field, when marked “Y”, indicates that the earlier residents of the households have been replaced by a new set of residents because the earlier residents have moved out and a new set of residents have moved in.",
    "Households are classified as belonging to one of the following groups.

Children - dominant
Youngsters - dominant
Other households of the Young
Grown-up - dominant
Seniors - dominant
Other households of Grown-ups
Balanced households with Seniors
Balanced households with no Seniors",
"A rule-based classification that takes into account all members of a household is better than classifying a household only on the basis of the occupation of a single member - usually the head of the household.

Households are classified as belonging to one of the 20 occupation groups*",
"Households are classified as belonging to one of the 11 education groups.*",
"Since a household usually has a mix of members of the genders and the distribution may vary from being dominated by one gender to the other with many cases of a balanced distribution, the classification of a household into a particular gender-group is based on certain rules set by CMIE.

Households are classified as belonging to one of the following gender groups.

Only Males
Male Dominated
Male Majority
Balanced
Female Majority
Female Dominated
Only Females"
    
  )
)|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 1 : Variables of interest with description",
                 subtitle = "Descriptions are copied or paraphrased from CMIE website")
```


## Summaries on variables of interest

Here with this data set we have four variables that classify a given household in four different ways. We will look at summaries for these four variables.

### Age Group

We begin by creating country level estimates for various Age-Groups.

```{r cntry-ag}

data_household_incomes|>
  pull(AGE_GROUP)|>
  unique() -> all_age_groups

## function to calculate the mean of a value in a grouping variable

get_means <- function(data, interest_var, 
                      interest_val, w,
                      R_U = 0){
  
  if(R_U == 0){ # National
    data|>
    mutate(
      if_interest_val = ifelse(
       .data[[interest_var]] == interest_val,
                               1,0)
    )|>
    summarise(
      "Perc_HH" := Mean(if_interest_val,
                                      weights = .data[[w]])
    )|>
    mutate(
      {{interest_var}} := interest_val
    )
  
  }else{
    if(R_U == 1){ # National - Rural/Urban
      data|>
    mutate(
      if_interest_val = ifelse(
       .data[[interest_var]] == interest_val,
                               1,0)
    )|>
    group_by(REGION_TYPE)|>
    summarise(
      "Perc_HH" := Mean(if_interest_val,
                                      weights = .data[[w]])
    )|>
    mutate(
      {{interest_var}} := interest_val
    )
    }else{ # State
      data|>
    mutate(
      if_interest_val = ifelse(
       .data[[interest_var]] == interest_val,
                               1,0)
    )|>
    group_by(STATE)|>
    summarise(
      "Perc_HH" := Mean(if_interest_val,
                                      weights = .data[[w]])
    )|>
    mutate(
      {{interest_var}} := interest_val
    )
    }
  
  }
}

# calculate country level estimates for all values of AGE_GROUP

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("AGE_GROUP",8),
  interest_val = all_age_groups,
  w = rep("w_cntry",8)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH)) -> national_age_group_perc

# National Rural Urban breakup of AGE Group

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("AGE_GROUP",8),
  interest_val = all_age_groups,
  w = rep("w_cntry",8),
  R_U = rep(1,8)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,values_from = Perc_HH)-> national_age_group_perc_ru

## Show both national level tables



national_age_group_perc_ru|>
  mutate(
    National = national_age_group_perc$Perc_HH
  )|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 2 : National - Percentage HH in Various Age Groups with Rural - Urban Breakup")

```

The following chart shows the spread of percentage of households across age groups for all states in India. __Maharashtra is in Yellow.__

```{r state-level-ag}
#| column: page
#| fig-align: center
#| fig-width: 40
#| fig-height: 20
#| fig-subcap: This chart is interactive. Hover your mouse over the chart to see details.
#| fig-cap: State level estimates are generated using state weights and Country level estimates are using country weights.

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("AGE_GROUP",8),
  interest_val = all_age_groups,
  w = rep("w_state",8),
  R_U = rep(2,8)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )-> state_perc_hh_age_group


state_perc_hh_age_group|>
  ggplot(aes(AGE_GROUP,Perc_HH))+
  ggiraph::geom_jitter_interactive(aes(
    colour = ifelse(
    STATE == "Maharashtra",
    "#ffca05",
    "#919ba5"
  ),
  tooltip = paste(
    AGE_GROUP," households in",STATE,":",Perc_HH,"%")
  ),
              size = 10,
              alpha = 0.8)+
  scale_colour_viridis_d()+
  guides(colour = "none")+
  geom_jitter(data = national_age_group_perc,
              aes(AGE_GROUP, Perc_HH),
              shape = 23,
              size = 15,
              alpha = 0.8,
              fill = "#2ca25f")+
  coord_flip()+
  labs(
    title = "Percentage of HH across various Age Groups",
    subtitle = "The diamond in green is the national average",
    x = NULL,
    y = "% households"
  )+
  theme_bw()+
  theme(
    title = element_text(size = 50,face = "bold"),
    axis.title = element_text(size = 35),
    axis.text = element_text(size = 25)
  )-> p1

ggiraph::girafe(ggobj = p1)

```


Below is the Urban and Rural breakup for Maharashtra households across age groups.

```{r maha-u-r-ag}
purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra")),
  interest_var = rep("AGE_GROUP",8),
  interest_val = all_age_groups,
  w = rep("w_state",8),
  R_U = rep(1,8)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,
              values_from = Perc_HH)|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 3 : Maharashtra - Percentage HH in Various Age Groups with Rural - Urban Breakup")

```


### Occupation Group

We begin by creating country level estimates for various Occupation-Groups.

```{r cntry-og}

data_household_incomes|>
  pull(OCCUPATION_GROUP)|>
  unique() -> all_occ_groups

# calculate country level estimates for all values of Occupation_GROUP

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("OCCUPATION_GROUP",19),
  interest_val = all_occ_groups,
  w = rep("w_cntry",19)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH)) -> national_occ_group_perc

# National Rural Urban breakup of AGE Group

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("OCCUPATION_GROUP",19),
  interest_val = all_occ_groups,
  w = rep("w_cntry",19),
  R_U = rep(1,19)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,values_from = Perc_HH)-> national_occ_group_perc_ru

## Show both national level tables



national_occ_group_perc_ru|>
  mutate(
    National = national_occ_group_perc$Perc_HH
  )|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 4 : National - Percentage HH in Various Occupation Groups with Rural - Urban Breakup")

```

The following chart shows the spread of percentage of households across occupation groups for all states in India. __Maharashtra is in Yellow.__

```{r state-level-og}
#| column: page
#| fig-align: center
#| fig-width: 40
#| fig-height: 40
#| fig-subcap: This chart is interactive. Hover your mouse over the chart to see details.
#| fig-cap: State level estimates are generated using state weights and Country level estimates are using country weights.

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("OCCUPATION_GROUP",19),
  interest_val = all_occ_groups,
  w = rep("w_state",19),
  R_U = rep(2,19)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )-> state_perc_hh_occ_group


state_perc_hh_occ_group|>
  ggplot(aes(OCCUPATION_GROUP,Perc_HH))+
  ggiraph::geom_jitter_interactive(aes(
    colour = ifelse(
    STATE == "Maharashtra",
    "#ffca05",
    "#919ba5"
  ),
  tooltip = paste(
    OCCUPATION_GROUP," households in",STATE,":",Perc_HH,"%")
  ),
              size = 10,
              alpha = 0.8)+
  scale_colour_viridis_d()+
  guides(colour = "none")+
  geom_jitter(data = national_occ_group_perc,
              aes(OCCUPATION_GROUP, Perc_HH),
              shape = 23,
              size = 15,
              alpha = 0.8,
              fill = "#2ca25f")+
  coord_flip()+
  labs(
    title = "Percentage of HH across various Occupation Groups",
    subtitle = "The diamond in green is the national average",
    x = NULL,
    y = "% households"
  )+
  theme_bw()+
  theme(
    title = element_text(size = 50,face = "bold"),
    axis.title = element_text(size = 35),
    axis.text = element_text(size = 25)
  )-> p2

ggiraph::girafe(ggobj = p2)

```


Below is the Urban and Rural breakup for Maharashtra households across Occupation groups.

```{r maha-u-r-og}
purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra")
              ),
  interest_var = rep("OCCUPATION_GROUP",19),
  interest_val = all_occ_groups,
  w = rep("w_state",19),
  R_U = rep(1,19)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,
              values_from = Perc_HH)|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 5 : Maharashtra - Percentage HH in Various Occupation Groups with Rural - Urban Breakup")

```

:::{.callout-note}
#### wage labourers - 6.41% for Maharashtra

A household is classified as that of wage labourers if it first qualifies as a household of small traders and daily wage labourers and having satisfied this condition, it also satisfies the condition that the number of wage labourers in the household is greater than the number of each of the following occupations - home based workers, small traders and hawkers and wage labourers.

A household qualifies as a household of small traders and wage labourers if the number of small traders and wage labourers in the household is greater than the number of business persons; is greater than the number of salaried employees; is greater than the number of farmers and; is greater than the number of retired and the miscellaneous.
:::

:::{.callout-note}
#### Small/Marginal Farmers - 13.31% for Maharashtra

A household is classified as that of small and marginal farmers if it first qualifies as a household of farmers and having satisfied this condition, it also satisfies the condition that the number of small and marginal farmers in the household is greater than the number of organised farmers.

A household qualifies as a household of farmers if the number of farmers in the household is greater than the number of business persons; is greater than the number of salaried employees; is greater than the number of small traders and daily wage labourers and; is greater than the number of retired and the miscellaneous.
:::

:::{.callout-note}

#### Self-employed Entrepreneurs - 14.49% for Maharashtra

A household qualifies as a household of business persons if the number of business persons is greater than the number of salaried employees; is greater than the number of farmers; is greater than the number of small traders and daily wage labourers and; is greater than the number of retired and the miscellaneous.
:::

:::{.callout-note}

#### Industrial workers - 7% for Maharashtra

A household is classified as that of industrial workers if it first qualifies as a household of salaried employees and having satisfied this condition, it also satisfies the condition that the number of industrial workers in the household is greater than the number of each of the following occupations - managers and supervisors, white-collar professional employees, white-collar clerical employees and non-industrial technical workers and also that, the number of industrial workers is greater than or equal to the number of members of each of the following two types of occupations - support staff and, legislators, social workers and activists.
A household qualifies as a household of salaried employees if the number of salaried employees is greater than the number of business persons; is greater than the number of farmers; is greater than the number of small traders and daily wage labourers and; is greater than the number of retired and the miscellaneous.
:::


### Education Group

We begin by creating country level estimates for various Education-Groups.

```{r cntry-eg}

data_household_incomes|>
  pull(EDUCATION_GROUP)|>
  unique() -> all_edu_groups

# calculate country level estimates for all values of Occupation_GROUP

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("EDUCATION_GROUP",12),
  interest_val = all_edu_groups,
  w = rep("w_cntry",12)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH)) -> national_edu_group_perc

# National Rural Urban breakup of AGE Group

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("EDUCATION_GROUP",12),
  interest_val = all_edu_groups,
  w = rep("w_cntry",12),
  R_U = rep(1,12)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,values_from = Perc_HH)-> national_edu_group_perc_ru

## Show both national level tables



national_edu_group_perc_ru|>
  mutate(
    National = national_edu_group_perc$Perc_HH
  )|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 6 : National - Percentage HH in Various Education Groups with Rural - Urban Breakup")

```

The following chart shows the spread of percentage of households across educaiton groups for all states in India. __Maharashtra is in Yellow.__

```{r state-level-eg}
#| column: page
#| fig-align: center
#| fig-width: 40
#| fig-height: 30
#| fig-subcap: This chart is interactive. Hover your mouse over the chart to see details.
#| fig-cap: State level estimates are generated using state weights and Country level estimates are using country weights.

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes),
  interest_var = rep("EDUCATION_GROUP",12),
  interest_val = all_edu_groups,
  w = rep("w_state",12),
  R_U = rep(2,12)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )-> state_perc_hh_edu_group


state_perc_hh_edu_group|>
  ggplot(aes(EDUCATION_GROUP,Perc_HH))+
  ggiraph::geom_jitter_interactive(aes(
    colour = ifelse(
    STATE == "Maharashtra",
    "#ffca05",
    "#919ba5"
  ),
  tooltip = paste(
    EDUCATION_GROUP," households in",STATE,":",Perc_HH,"%")
  ),
              size = 10,
              alpha = 0.8)+
  scale_colour_viridis_d()+
  guides(colour = "none")+
  geom_jitter(data = national_edu_group_perc,
              aes(EDUCATION_GROUP, Perc_HH),
              shape = 23,
              size = 15,
              alpha = 0.8,
              fill = "#2ca25f")+
  coord_flip()+
  labs(
    title = "Percentage of HH across various Education Groups",
    subtitle = "The diamond in green is the national average",
    x = NULL,
    y = "% households"
  )+
  theme_bw()+
  theme(
    title = element_text(size = 50,face = "bold"),
    axis.title = element_text(size = 35),
    axis.text = element_text(size = 25)
  )-> p2

ggiraph::girafe(ggobj = p2)

```

:::{.callout-important}

#### Unintutive Result? TL;DR - No, we did not look at composition.

We notice that the chart shows that % of HHs in Maharashtra that are grouped as HH of all Literates is ~30%. This seems unintuitive. Moreover, states such as Rajasthan and Bihar are recording more higher proportions of HHs as HHs of Literates compared to Kerala.

This is nothing to worry about, we forgot to look at composition of grouping for each state. Meaning, that while Bihar may have a higher proportion of HHs in All literates grouping, states like Kerala and Maharashtra have higher proportions in groups like majority or dominated by graduated or Matriculated. This makes sense. __Nothing to worry.__

_See the table below to see state level results for HHs across all groups._
:::

```{r data-intuition-check-eg}

data_household_incomes|>
  mutate(
    if_HH_all_litts = ifelse(
      EDUCATION_GROUP == "Households of all literates",
      1,0
    ),
    if_HH_major_dom_grads = ifelse(
      EDUCATION_GROUP %in% c("Graduates majority household",
        "Graduates dominated household"),
      1,0
    ),
    if_HH_minor_grads = ifelse(
      EDUCATION_GROUP == "Graduates minority household",
      1,0
    ),
    if_HH_all_grads = ifelse(
      EDUCATION_GROUP == "All Graduates household",
      1,0
    ),
    if_HH_major_dom_matri = ifelse(
      EDUCATION_GROUP %in% c("Matriculates majority household",
        "Matriculates dominated household"),
      1,0
    ),
    if_HH_minor_matri = ifelse(
      EDUCATION_GROUP == "Matriculates minority householdd",
      1,0
    ),
    if_HH_all_matri = ifelse(
      EDUCATION_GROUP == "All Matriculates household",
      1,0
    ),
    if_HH_some_litts = ifelse(
      EDUCATION_GROUP == "Households of some literates",
      1,0
    ),
    if_HH_all_illitts = ifelse(
      EDUCATION_GROUP == "Households of all illiterates",
      1,0
    )
  )|>
  group_by(STATE)|>
  summarise(
    across(
      .cols = starts_with(match = "if_HH_"),
      .fns = ~round(Mean(.x, weights = w_state)*100,2)
    )
  )|>
  reactable::reactable(defaultSorted = c("STATE",
                                         "if_HH_all_litts",
                                         "if_HH_minor_grads",
                                         "if_HH_all_grads",
                                         "if_HH_major_dom_grads",
                                         "if_HH_all_matri",
                                         "if_HH_major_dom_matri",
                                         "if_HH_minor_matri",
                                         "if_HH_some_litts",
                                         "if_HH_all_illitts"),
                       columns = list(
                         
                         
                         if_HH_all_litts = reactable::colDef(
                           name = "All Litts"
                         ),
                         if_HH_minor_grads = reactable::colDef(
                           name = "Minority Grads"
                         ),
                         if_HH_all_grads = reactable::colDef(
                           name = "All Grads"
                         ),
                         if_HH_major_dom_grads = reactable::colDef(
                           name = "Major/dom Grads"
                         ),
                         if_HH_all_matri = reactable::colDef(
                           name = "All Matri"
                         ),
                         if_HH_major_dom_matri = reactable::colDef(
                           name = "Major/dom Matri"
                         ),
                         if_HH_minor_matri = reactable::colDef(
                           name = "Minority Matri"
                         ),
                         if_HH_some_litts = reactable::colDef(
                           name = "Some Litts"
                         ),
                         if_HH_all_illitts = reactable::colDef(
                           name = "All illLitts"
                         )
                         
                       ), 
                       defaultPageSize = 28
                       )


```


Below is the Urban and Rural breakup for Maharashtra households across Education groups.

```{r maha-u-r-eg}
purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra")
              ),
  interest_var = rep("EDUCATION_GROUP",12),
  interest_val = all_edu_groups,
  w = rep("w_state",12),
  R_U = rep(1,12)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,
              values_from = Perc_HH)|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 7 : Maharashtra - Percentage HH in Various Education Groups with Rural - Urban Breakup")

```





### Gender Group

We begin by creating country level estimates for various Gender-Groups.

```{r cntry-gg}

data_household_incomes|>
  pull(GENDER_GROUP)|>
  unique() -> all_gen_groups

# calculate country level estimates for all values of Occupation_GROUP

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes),
  interest_var = rep("GENDER_GROUP",7),
  interest_val = all_gen_groups,
  w = rep("w_cntry",7)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH)) -> national_gen_group_perc

# National Rural Urban breakup of GENDER Group

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes),
  interest_var = rep("GENDER_GROUP",7),
  interest_val = all_gen_groups,
  w = rep("w_cntry",7),
  R_U = rep(1,7)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,values_from = Perc_HH)-> national_gen_group_perc_ru

## Show both national level tables



national_gen_group_perc_ru|>
  mutate(
    National = national_gen_group_perc$Perc_HH
  )|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 8 : National - Percentage HH in Various GENDER Groups with Rural - Urban Breakup")

```

The following chart shows the spread of percentage of households across gender groups for all states in India. __Maharashtra is in Yellow.__

```{r state-level-gg}
#| column: page
#| fig-align: center
#| fig-width: 40
#| fig-height: 25
#| fig-subcap: This chart is interactive. Hover your mouse over the chart to see details.
#| fig-cap: State level estimates are generated using state weights and Country level estimates are using country weights.

purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes,data_household_incomes,
              data_household_incomes),
  interest_var = rep("GENDER_GROUP",7),
  interest_val = all_gen_groups,
  w = rep("w_state",7),
  R_U = rep(2,7)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )-> state_perc_hh_gen_group


state_perc_hh_gen_group|>
  ggplot(aes(GENDER_GROUP,Perc_HH))+
  ggiraph::geom_jitter_interactive(aes(
    colour = ifelse(
    STATE == "Maharashtra",
    "#ffca05",
    "#919ba5"
  ),
  tooltip = paste(
    GENDER_GROUP," households in",STATE,":",Perc_HH,"%")
  ),
              size = 10,
              alpha = 0.8)+
  scale_colour_viridis_d()+
  guides(colour = "none")+
  geom_jitter(data = national_gen_group_perc,
              aes(GENDER_GROUP, Perc_HH),
              shape = 23,
              size = 15,
              alpha = 0.8,
              fill = "#2ca25f")+
  coord_flip()+
  labs(
    title = "Percentage of HH across various Gender Groups",
    subtitle = "The diamond in green is the national average",
    x = NULL,
    y = "% households"
  )+
  theme_bw()+
  theme(
    title = element_text(size = 50,face = "bold"),
    axis.title = element_text(size = 35),
    axis.text = element_text(size = 25)
  )-> p3

ggiraph::girafe(ggobj = p3)

```


Below is the Urban and Rural breakup for Maharashtra households across Gender groups.

```{r maha-u-r-gg}
purrr::pmap_dfr(.l = list(
  data = list(data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ,data_household_incomes|>
                filter(STATE == "Maharashtra"),
              data_household_incomes|>
                filter(STATE == "Maharashtra")
              ),
  interest_var = rep("GENDER_GROUP",7),
  interest_val = all_gen_groups,
  w = rep("w_state",7),
  R_U = rep(1,7)
),
.f = get_means 
  )|>
  mutate(
    Perc_HH = round(Perc_HH*100,2)
  )|>
  arrange(desc(Perc_HH))|>
  pivot_wider(names_from = REGION_TYPE,
              values_from = Perc_HH)|>
  gt::gt()|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 7 : Maharashtra - Percentage HH in Various Gender Groups with Rural - Urban Breakup")

```


## Income Quantiles

This section will contain estimates of income quantiles at national and state level with Urban-Rural lens. 

This section will also probe into distances between income quantiles of HHs grouped under various occupation groups.

The CMIE data reports the `TOTAL_INCOME` of a household. The description of this indicator as provided on the CMIE website: 
_"This is the total income of a household during a month. It is the summation of total income of every earning member and the income of the household collectively, which cannot be attributed to any individual member. This includes income received from all sources such as rent, income earned from self production, private transfers, wages, overtime, bonus, etc."_

```{r def-fun-inq}

get_inc_quantiles <- function(
  level = "national", 
  with_ur_lens = "no",
  state
  ){
  
  if(level == "national" & with_ur_lens == "no"){
    
    Quantile(data_household_incomes$TOTAL_INCOME,
         weights = data_household_incomes$w_cntry)-> nat_inc_q
    
    tibble(
      quantile = c("0%","25%","50%","75%","100%"),
      national_inc = nat_inc_q
    )
    
  }else if(level == "national" & with_ur_lens == "yes"){
    
    data_household_incomes|>
      filter(REGION_TYPE == "RURAL")|>
      pull(TOTAL_INCOME) -> nat_rural_inc
    
    data_household_incomes|>
      filter(REGION_TYPE == "RURAL")|>
      pull(w_cntry) -> nat_rural_w
    
    data_household_incomes|>
      filter(REGION_TYPE == "URBAN")|>
      pull(TOTAL_INCOME) -> nat_urban_inc
    
    data_household_incomes|>
      filter(REGION_TYPE == "URBAN")|>
      pull(w_cntry) -> nat_urban_w
    
    Quantile(
      nat_rural_inc,
      weights = nat_rural_w
    ) -> nat_rural_inc_q
    
    Quantile(
      nat_urban_inc,
      weights = nat_urban_w
    ) -> nat_urban_inc_q
    
    tibble(
      quantile = c("0%","25%","50%","75%","100%"),
      nat_rural_inc = nat_rural_inc_q,
      nat_urban_inc = nat_urban_inc_q
    )
    
  } else if(level != "national" & with_ur_lens == "no"){
    
    data_household_incomes|>
      filter(STATE == state)|>
      pull(TOTAL_INCOME) -> state_inc
    
    data_household_incomes|>
      filter(STATE == state)|>
      pull(w_state) -> state_w
    
    Quantile(
      state_inc,
      weights = state_w
    ) -> state_inc_q
    
    tibble(
      quantile = c("0%","25%","50%","75%","100%"),
      "{{state}}_inc" := state_inc_q
    )
    
  }else{
    data_household_incomes|>
      filter(STATE == state)|>
      filter(REGION_TYPE == "RURAL")|>
      pull(TOTAL_INCOME) -> sat_rural_inc
    
    data_household_incomes|>
      filter(STATE == state)|>
      filter(REGION_TYPE == "RURAL")|>
      pull(w_state) -> sat_rural_w
    
    data_household_incomes|>
      filter(STATE == state)|>
      filter(REGION_TYPE == "URBAN")|>
      pull(TOTAL_INCOME) -> sat_urban_inc
    
    data_household_incomes|>
      filter(STATE == state)|>
      filter(REGION_TYPE == "URBAN")|>
      pull(w_state) -> sat_urban_w
    
    Quantile(
      sat_rural_inc,
      weights = sat_rural_w
    ) -> sat_rural_inc_q
    
    Quantile(
      sat_urban_inc,
      weights = sat_urban_w
    ) -> sat_urban_inc_q
    
    tibble(
      quantile = c("0%","25%","50%","75%","100%"),
      "{{state}}_rural_inc" := sat_rural_inc_q,
      "{{state}}_urban_inc" := sat_urban_inc_q
    )
  }
  
}

```


### Naitonal Level

```{r nat-incq}
#| layout-nrow: 1
#| column: body

cbind(get_inc_quantiles(level = "national"),
get_inc_quantiles(level = "national", 
                  with_ur_lens = "yes"))|>
  select(-3)|>
  gt::gt()|>
  gt::tab_options(heading.subtitle.font.size = 8)|>
  gt::cols_align(align = "center")|>
  gt::tab_header(title = "Table 8 : National Income Quantiles")

```

```{r dist-incq-chart}
#| column: page
#| fig-align: center
#| fig-width: 40
#| fig-height: 25
#| fig-cap: X-axis is transformed to a log10 scale.
#| fig-subcap: Nearly 16.8 crore HH are spread in the area left of the verticle grey line and same number of HHs are spread on the right of the line.

cbind(get_inc_quantiles(level = "national"),
      get_inc_quantiles(level = "national", 
                        with_ur_lens = "yes"))|>
  select(-3)|>
  pivot_longer(cols = -quantile,names_to = "Region",
               values_to = "income")|>
  mutate(
    quantile = forcats::as_factor(quantile),
    Region = case_when(
      Region == "national_inc" ~ "National",
      Region == "nat_urban_inc" ~ "National Urban Region",
      Region == "nat_rural_inc" ~ "National Rural Region",
    )
  )|>
  ggplot(aes(income,Region))+
  ggiraph::geom_point_interactive(aes(colour = quantile,
                             tooltip = paste(
                               Region,":",
                               quantile,"quantile is",
                               income
                             )),
             size =15)+
  scale_colour_manual(values = c("#141a28","#962e21","#dec000","#99b898","#347d39"), 
                      name = "Quantiles")+
  geom_vline(aes(xintercept = 17000),
             shape = 2, colour = "#919ba5")+
  scale_x_log10(
    breaks = c(0,2.8^seq(0, 9, by = 1) * 100),
    labels = scales::label_dollar(prefix = "Rs")
  )+
  labs(
    title = "Distances between Income Quantiles",
    subtitle = "50% of HHs at National level report total monthly incomes less than INR 17,000",
    y = NULL,
    x = "Income",
    caption = "ज़िंदगी तू ने मुझे क़ब्र से कम दी है ज़मीं 

पाँव फैलाऊँ तो दीवार में सर लगता है "
  )+
  theme_bw()+
  theme(plot.title.position = 'plot',
        title = element_text(size = 50,face = "bold"),
        axis.title = element_text(size = 35),
        axis.text = element_text(size = 25),
        legend.text = element_text(size = 25)) -> p4

ggiraph::girafe(ggobj = p4)

```


### State Level Comparisons 

```{r sat-incq}
purrr::pmap_dfc(.l = list(
  level = rep("state",28),
  with_ur_lens = rep("no",28),
  state = unique(data_household_incomes$STATE)
),
.f = get_inc_quantiles) |>
  janitor::clean_names()|>
  rename(Quantiles = quantile_1)|>
  select(!tidyselect::contains("quantile_"))|>
  pivot_longer(cols = -Quantiles,
               names_to = "State",
               values_to = "Income" )|>
  mutate(
    State = stringr::str_to_title(
      stringr::str_replace(
        stringr::str_remove_all(State,"_inc"),
        "_"," "
      )),
    State = ifelse(State == "Jammu Kashmir",
                   "Jammu & Kashmir", State),
    Quantiles = forcats::as_factor(Quantiles)
  ) -> state_income_quantiles

```

```{r state-incq-comp-chart}
#| column: screen
#| fig-align: center
#| fig-width: 40
#| fig-height: 40
#| fig-cap: X-axis is transformed to a log10 scale.

state_income_quantiles|>
  ggplot(aes(Income,State))+
  ggiraph::geom_point_interactive(aes(colour = Quantiles,
                             tooltip = paste(
                               State,":",
                               Quantiles,"quantile is",
                               Income
                             )),
             size =15)+
  scale_colour_manual(values = c("#141a28","#962e21","#dec000","#99b898","#347d39"), 
                      name = "Quantiles")+
  geom_vline(aes(xintercept = 17000),
             shape = 2, colour = "#919ba5")+
  scale_x_log10(
    breaks = c(0,2.8^seq(0, 9, by = 1) * 100),
    labels = scales::label_dollar(prefix = "Rs")
  )+
  labs(
    title = "State comparisons - Distances between Income Quantiles",
    subtitle = "Verticle Line is the National Median",
    y = NULL,
    x = "Income")+
  theme_bw()+
  theme(plot.title.position = 'plot',
        title = element_text(size = 50,face = "bold"),
        axis.title = element_text(size = 35),
        axis.text = element_text(size = 25),
        legend.text = element_text(size = 25),
        legend.position = "top",
        legend.direction = "horizontal"
        ) -> p5

ggiraph::girafe(ggobj = p5)

```

